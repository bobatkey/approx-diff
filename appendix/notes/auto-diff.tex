\subsection{Automatic differentiation}

For a differentiable manifold $M$, write $\tangents_x(M)$ for the tangent space at a point $x \in M$ and
$\cotangents_x(M)$ for the cotangent space at $x$. Now consider flat manifolds of the form $\RR^n$.

\begin{itemize}
\item The \emph{forward derivative} (tangent map or pushforward) $\pushf{f}_x$ of a differentiable function
$f: \RR^m \to \RR^n$ at $x \in \RR^m$ is the unique linear map $\tangents_x(\RR^m) \linearto
\tangents_{f(x)}(\RR^n)$ given by the Jacobean matrix of $f$ at $x$. Since $\RR^n$ is flat,
$\tangents_x(\RR^n)$ is canonically isomorphic to $\RR^n$, so in fact $\pushf{f}_x$ is a linear map $\RR^m
\linearto \RR^n$.
\item The \emph{backward derivative} (cotangent map or pullback) $\pullf{f}_x$ is the unique linear map
$\cotangents_{f(x)}(\RR^n) \linearto \cotangents_x(\RR^m)$ given by the transpose (adjoint) of the Jacobean
matrix of $f$ at $x$. Since $\RR^n$ is flat, $\cotangents_x(\RR^n)$ is also canonically isomorphic to $\RR^n$,
so in fact $\pullf{f}_x$ is a linear map $\RR^n \linearto \RR^m$.
\end{itemize}

\subsubsection{Chain rule}

Derivatives respect composition. Suppose $f: \RR^m \to \RR^n$ and $g: \RR^n \to \RR^k$. For any $x \in \RR^m$
we have:

\begin{itemize}
\item $\pushf{(g \comp f)}_x = \pushf{g}_{f(x)} \comp \pushf{f}_x: \RR^m \to \RR^k$
\item $\pullf{(g \comp f)}_x = \pullf{f}_{x} \comp \pullf{g}_{f(x)}: \RR^k \to \RR^m$
\end{itemize}

\subsubsection{Forward mode automatic differentiation}

\begin{definition}
Define the functor $\tangents$ which sends every vector space $\RR^n$ to itself and every differentiable map
$f: \RR^m \to \RR^n$ to the function $\tangents(f) = x \mapsto (f(x), \pushf{f}_x): \RR^m \to \RR^n \times
(\RR^m \linearto \RR^n)$, associating to every point its image in $f$ and the forward derivative of $f$ at
that point.
\end{definition}

For any map $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ define $f_1 = \pi_1 \comp f: \RR^m \to \RR^n$
and $f_2 = \pi_2 \comp f: \RR^m \to (\RR^m \linearto \RR^n)$.

\begin{definition}[$\Diff$]
\label{def:auto-diff:Diff}
Define $\Diff$ to be the category where the objects are all finite vector spaces $\RR^n$ and the morphisms
are all maps $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ with $f_1$ differentiable. Composition in
$\Diff$ is given by:
\begin{align*}
(g \comp f)_1(x) &= f_1(g_1(x)) \\
(g \comp f)_2(x) &= g_2(f_1(x)) \comp f_2(x)
\end{align*}
\end{definition}

We can verify that $\tangents$ is indeed a functor, regardless of whether the linear maps $\RR^m \linearto
\RR^n$ happen to be derivatives. But if $f_2(x)$ is the derivative of $f_1$ at $x$ for any $x \in \RR^m$ and
similarly for $g$ then the derivatives compose according to the forward chain rule and $(g \comp f)_2(x)$ is
the derivative of $(g \comp f)_1$ at $x$.

\subsubsection{$\Diff$ as a subcategory of $\Fam(\FinVect)$}

Recall that $\Fam(\FinVect)$ denotes the Grothendieck construction $\Grothendieck{X}\Fam(X, \FinVect)$. The
functor $\Diff \hookrightarrow \Fam(\FinVect)$ which send objects $\RR^n$ to constant families of tangent
spaces $(\RR^n, \const(\RR^n))$ and morphisms $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ to pairs
$(f_1, f_2)$ of differentiable functions $f_1: \RR^m \to \RR^n$ and families of linear maps $f_2: \{{f_2}_x:
\RR^m \linearto \RR^n\}_{x \in \RR^m}$ exhibits $\Diff$ as equivalent to a full subcategory of
$\Fam(\FinVect)$.

For any $(f, \partial f): (\RR^m, \const(\RR^m)) \to (\RR^n, \const(\RR^n))$ and $(g, \partial g): (\RR^n,
\const(\RR^n)) \to (\RR^k, \const(\RR^k))$ in that subcategory, we have that for any $x \in \RR^m$:
\begin{itemize}
\item $\partial f_x: \RR^m \to \RR^n$;
\item $\reindex{\partial g}{f}_x = \partial g_{f(x)}: \RR^n \to \RR^k$.
\end{itemize}

\noindent The composition $(g, \partial g) \comp (f, \partial f) = (g \comp f, \reindex{\partial g}{f} \comp
\partial f): (\RR^m, \const(\RR^m)) \to (\RR^k, \const(\RR^k))$ corresponds exactly to the forward chain rule,
since $(\reindex{\partial g}{f} \comp \partial f)_x = {\partial g}_{f(x)} \comp {\partial f}_x$.

\subsubsection{Reverse mode automatic differentiation}

\begin{definition}
Define the functor $\cotangents$ which sends every vector space $\RR^n$ to itself and every differentiable map
$f: \RR^m \to \RR^n$ to the function $\cotangents(f) = x \mapsto (f(x), \pullf{f}_x): \RR^m \to \RR^n \times
(\RR^n \linearto \RR^m)$.
\end{definition}

\noindent and again define a corresponding category $\Diff^*$ (equivalent to a full subcategory of
$\Fam(\FinVect^\op)$) of such maps where composition of the cotangent maps respects the backward chain rule.

\todo{The reason we can't combine $\Diff$ and $\Diff^*$ into a single category, with morphisms $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n) \times (\RR^n \linearto \RR^m)$ is..?}

\subsubsection{Galois slicing via category of families}

Now recall that $\Fam(\LatGal)$ is the Grothendieck construction $\Grothendieck{X}\Fam(X, \LatGal)$, with:
\begin{itemize}
\item as objects $(X, \partial X)$ all pairs of a set $X$ and and for each $x \in X$, a bounded lattice
$\partial X_x$;
\item as morphisms $(X, \partial X) \to (Y, \partial Y)$, all pairs $(f, \partial f)$ of functions $f: X \to
Y$ and Galois connections $\partial f: \partial X_x \to \partial Y_{f(x)}$.
\end{itemize}
