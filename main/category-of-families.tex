\subsection{Grothendieck Construction for Indexed Categories}
\label{sec:Grothendieck}

The goal now is to equip the interpretation of a (first-order) program with a Galois connection relating
approximations of its inputs to approximations of its output. Since the specific lattices of approximations
depend on the value being approximated, the semantics of every type $\tau$ must have both a ``conventional''
component, providing the set $X$ which interprets $\tau$, plus an associated lattice of approximations
$\partial X(x)$ for every point $x \in X$. The semantics of an expression $e$ of type $\sigma$ with a single
free variable of type $\tau$ (with $\tau$ and $\sigma$ denoting $X$ and $Y$) must then also have two
components: a function $f: X \to Y$ giving the conventional interpretation of $e$, plus a family of Galois
connections $\partial f(x): \partial X(x) \to \partial Y(f(x))$ for every $x \in X$ which can be used for
slicing over that expression.

This pattern of objects and morphisms is captured by the construction used in CHAD~\cite{vákár22,nunes2023} to
describe automatic differentiation, namely the \emph{Grothendieck construction} for a particular indexed
category $T: \Set^\op \to \Cat$. For CHAD, $T(X)$ will be the functor category $\Func{X}{\FinVect}$, regarded
as the category of $X$-indexed families of finite vector spaces, with indexed linear maps; for Galois slicing
we will take $T(X) = \Func{X}{\LatGal}$, the category of $X$-indexed families of bounded lattices, with
indexed Galois connections as morphisms. The Grothendieck construction
$\Grothendieck{}T$~(\defref{Grothendieck} below) for an indexed category $T$, sometimes called the \emph{total
category} for $T$, is the category of all $\Set$-indexed families of objects of $T$, together with morphisms
that account for both structure within each family and how families transform under reindexing.

First we formalise $X$-indexed families and their categories.

\begin{definition}[Category of $X$-indexed families]
For any set $X$ (regarded as a discrete category) and any category $\cat{C}$, recall that the functor
category $\Func{X}{\cat{C}}$ has as objects all functors $F: X \to \cat{C}$, namely $X$-indexed families of
objects of $\cat{C}$, and as morphisms from $F \to G$, all families of morphisms $\eta(x): F(x) \to G(x)$ in
$\cat{C}$ for every $x \in X$, with naturality trivial because $X$ has only identity morphisms.
\end{definition}

Like any functor category $\Func{X}{\cat{C}}$ inherits limits and colimits pointwise from its codomain.

\begin{proposition}
If $\cat{C}$ has limits (resp.~colimits) then $\Func{X}{\cat{C}}$ has limits (resp.~colimits) computed
pointwise.
\end{proposition}

\begin{definition}[Reindexing]
For any function $f: X \to Y$ define the \emph{reindexing} functor $\reindex{-}{f}: \Func{Y}{\cat{C}} \to
\Func{X}{\cat{C}}$ which sends any $Y$-indexed family $F$ over $\cat{C}$ to the $X$-indexed family
$\reindex{F}{f} = F \comp f$ (regarding $f$ as a functor between $X$ and $Y$ as discrete categories) and any
family of morphisms $\eta: F \to G$ to $\reindex{\eta}{f}: \reindex{F}{f} \to \reindex{G}{f}$ with
$\reindex{\eta}{f}(x) = \eta(f(x))$.
\end{definition}

Although reindexing is just precomposition with $f$, writing it as $\reindex{-}{f}$ avoids notational
confusion when combining composition of morphisms in $\Func{X}{C}$ with reindexing.

\begin{definition}
\label{def:Grothendieck}
Suppose an indexed category $T: \cat{C}^\op \to \Cat$. The \emph{Grothendieck construction} for $T$ is the
category $\Grothendieck{X}T(X)$ (also written $\Grothendieck{}T$) which has as objects, all pairs $(X,
\partial X)$ of an object $X$ of $\cat{C}$ and an object $\partial X$ of $T(X)$, and as morphisms $(X,
\partial X) \to (Y, \partial Y)$, all pairs $(f, \partial f)$ of morphisms $f: X \to Y$ in $\cat{C}$ and
morphisms $\partial f: \partial X \to T(f)(\partial Y)$ in $T(X)$.
\end{definition}

\noindent The $\partial X$ notation is intended to suggest the connection between the Grothendieck
construction and the idea of tangent spaces and derivatives. To understand how the $\partial f$ components
compose, consider any $(f, \partial f): (X, \partial X) \to (Y, \partial Y)$ and $(g, \partial g): (Y,
\partial Y) \to (Z, \partial Z)$ in $\Grothendieck{}T$. We have:

\begin{itemize}
\item $\partial f: \partial X \to T(f)(\partial Y)$, and
\item $T(f)(\partial g): T(f)(\partial Y) \to T(f)(T(g)(\partial Z)) = T(g \comp f)(\partial Z)$
\end{itemize}

\noindent where $T(f)(\partial g)$ is the image of $\partial g$ in the ``reindexing'' functor $T(f)$. The
composition $(g, \partial g) \comp (f, \partial f): (X, \partial X) \to (Z, \partial Z)$ is then given by $(g
\comp f, T(f)(\partial g) \comp \partial f)$.

\subsection{Category of Families}
\label{sec:Fam}

Of interest to us is the Grothendieck construction for $\Func{-}{\cat{C}}: \Set^{\op} \to \Cat$, the indexed
category which sends any set $X$ to the category of $X$-indexed families $\Func{X}{\cat{C}}$ and any function
$f: X \to Y$ to the reindexing functor $\reindex{-}{f}: \Func{Y}{\cat{C}} \to \Func{X}{\cat{C}}$ .

\begin{definition}[Category of families]
\label{def:Fam}
For any category $\cat{C}$ define $\Fam(\cat{C})$ to be the Grothendieck construction
$\Grothendieck{X}\Func{X}{\cat{C}}$.
\end{definition}

\noindent In $\Fam(\cat{C})$ the objects $(X, \partial X)$ are thus sets $X$ paired with indexed families
$\partial X: X \to \cat{C}$ and morphisms $(f, \partial f): (X, \partial X) \to (Y, \partial Y)$ are functions
$f: X \to Y$ paired with morphisms $\partial f: \partial X \to \partial \reindex{Y}{f}$ in
$\Func{X}{\cat{C}}$.

\subsection{Galois Slicing via a Category of Families}

The total category $\Fam(\LatGal)$ is then basic setting for interpreting first-order programs for \GPS. This
has as objects $(X, \partial X)$, all pairs of a set $X$ and and for every $x \in X$, a bounded lattice
$\partial X(x)$, and as morphisms $(X, \partial X) \to (Y, \partial Y)$, all pairs $(f, \partial f)$ of a
function $f: X \to Y$ and for every $x \in X$, a Galois connection $\partial f(x): \partial X(x) \to \partial
Y(f(x))$. This is precisely the setup we identified informally at the beginning of this section. The pullback
(reindexing) along $f$ in the composition $(g, \partial g) \comp (f, \partial f) = (g \comp f,
\reindex{\partial g}{f} \comp \partial f)$ selects the appropriate lattice of approximations and Galois
connection at each point, using the baseline (unapproximated) function $f$.

\subsection{Automatic Differentiation via a Category of Families}

Following the CHAD approach, automatic differentiation for first-order programs can also be recovered in this
setup, via the total category $\Fam(\FinVect)$. We recapitulate the basic idea here. For flat manifolds like
$\RR^n$, the tangent space and cotangent space at a point $x$ are both canonically isomorphic to $\RR^n$, so
the forward and backward derivatives at $x$ of a differentiable function $f: \RR^m \to \RR^n$ have the
following form.

\begin{itemize}
\item The \emph{forward derivative} (tangent map or pushforward) $\pushf{f}_x$ of $f$ at $x \in \RR^m$ is the
unique linear map $\RR^m \linearto \RR^n$ given by the Jacobean matrix of $f$ at $x$.
\item The \emph{backward derivative} (cotangent map or pullback) $\pullf{f}_x$ is the unique linear map
$\RR^n \linearto \RR^m$ given by the transpose (adjoint) of the Jacobean matrix of $f$ at $x$.
\end{itemize}

\subsubsection{Chain rule}

Derivatives respect composition. Suppose $f: \RR^m \to \RR^n$ and $g: \RR^n \to \RR^k$. For any $x \in \RR^m$
we have:

\begin{itemize}
\item $\pushf{(g \comp f)}_x = \pushf{g}_{f(x)} \comp \pushf{f}_x: \RR^m \to \RR^k$
\item $\pullf{(g \comp f)}_x = \pullf{f}_{x} \comp \pullf{g}_{f(x)}: \RR^k \to \RR^m$
\end{itemize}

\subsubsection{Forward mode automatic differentiation}

\begin{definition}
Define the functor $\tangents$ which sends every vector space $\RR^n$ to itself and every differentiable map
$f: \RR^m \to \RR^n$ to the function $\tangents(f) = x \mapsto (f(x), \pushf{f}_x): \RR^m \to \RR^n \times
(\RR^m \linearto \RR^n)$, associating to every point its image in $f$ and the forward derivative of $f$ at
that point.
\end{definition}

For any map $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ it is useful to define $f_1 = \pi_1 \comp f:
\RR^m \to \RR^n$ and $f_2 = \pi_2 \comp f: \RR^m \to (\RR^m \linearto \RR^n)$.

\begin{definition}[$\Diff$]
\label{def:auto-diff:Diff}
\todo{Overkill -- try and give a construction that lives in $\Fam(\FinVect)$ directly} Define $\Diff$
to be the category where the objects are all finite vector spaces $\RR^n$ and the morphisms are all maps $f:
\RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ with $f_1$ differentiable. Composition in $\Diff$ is given by:
\begin{align*}
(g \comp f)_1(x) &= f_1(g_1(x)) \\
(g \comp f)_2(x) &= g_2(f_1(x)) \comp f_2(x)
\end{align*}
\end{definition}

We can verify that $\tangents$ is indeed a functor, regardless of whether the linear maps $\RR^m \linearto
\RR^n$ happen to be derivatives. But if $f_2(x)$ is the derivative of $f_1$ at $x$ for any $x \in \RR^m$ and
similarly for $g$ then the derivatives compose according to the forward chain rule and $(g \comp f)_2(x)$ is
the derivative of $(g \comp f)_1$ at $x$.

\subsubsection{Embedding into $\Fam(\FinVect)$}
\label{sec:galois-slicing-auto-diff-via-fam:auto-diff}

Consider the functor $\Diff \hookrightarrow \Fam(\FinVect)$ which send objects $\RR^n$ to constant families of
tangent spaces $(\RR^n, \const(\RR^n))$ and morphisms $f: \RR^m \to \RR^n \times (\RR^m \linearto \RR^n)$ to
pairs $(f_1, f_2)$ of differentiable functions $f_1: \RR^m \to \RR^n$ and families of linear maps $f_2:
\{{f_2}_x: \RR^m \linearto \RR^n\}_{x \in \RR^m}$. This exhibits $\Diff$ as equivalent to a full subcategory
of $\Fam(\FinVect)$.

In that subcategory, for any $(f, \partial f): (\RR^m, \const(\RR^m)) \to (\RR^n, \const(\RR^n))$ and $(g,
\partial g): (\RR^n, \const(\RR^n)) \to (\RR^k, \const(\RR^k))$, we have that for any $x \in \RR^m$:
\begin{itemize}
\item $\partial f_x: \RR^m \to \RR^n$;
\item $\reindex{\partial g}{f}_x = \partial g_{f(x)}: \RR^n \to \RR^k$.
\end{itemize}

\noindent The composition $(g, \partial g) \comp (f, \partial f) = (g \comp f, \reindex{\partial g}{f} \comp
\partial f): (\RR^m, \const(\RR^m)) \to (\RR^k, \const(\RR^k))$ corresponds exactly to the forward chain rule,
since $(\reindex{\partial g}{f} \comp \partial f)_x = {\partial g}_{f(x)} \comp {\partial f}_x$.
